<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAR Production Optimizer</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --accent: #007acc;
            --text-main: #d4d4d4;
            --text-mute: #858585;
            --border: #3e3e42;
            --success: #4ec9b0;
            --warn: #ce9178;      /* Orange */
            --highlight: #dcdcaa; /* Yellow */
            
            /* Resource Colors */
            --res-metal: #64b5f6; /* Light Blue */
            --res-energy: #ffd700; /* Gold */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 1200px; max-width: 100%; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        /* Sidebar & Panels */
        .sidebar { background: var(--bg-panel); padding: 20px; border: 1px solid var(--border); border-radius: 4px; }
        .main-content { background: var(--bg-panel); padding: 20px; border: 1px solid var(--border); border-radius: 4px; }
        
        /* Inputs */
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.85rem; color: var(--text-mute); margin-bottom: 5px; }
        select, input { width: 100%; padding: 8px; background: #3c3c3c; border: 1px solid var(--border); color: white; border-radius: 3px; box-sizing: border-box; }
        input:focus, select:focus { outline: 1px solid var(--accent); }
        
        /* Header Stats - Updated to 6 columns */
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; background: #333; padding: 10px; border-radius: 4px; }
        .stat-box small { display: block; color: var(--text-mute); font-size: 0.8rem; }
        .stat-box span { font-weight: bold; font-size: 1.1rem; }
        
        /* Rec Box */
        .recommendation-box { background: rgba(0, 122, 204, 0.15); border-left: 4px solid var(--accent); padding: 15px; margin-bottom: 25px; display: none; }
        .rec-title { font-weight: bold; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .rec-main { font-size: 1.4rem; margin: 5px 0; font-weight: bold; }
        .rec-sub { color: var(--text-mute); font-size: 0.9rem; }

        /* Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #3e3e42; }
        th { color: var(--text-mute); font-weight: normal; }

        /* --- CELL STYLES --- */
        .style-green { background: rgba(78, 201, 176, 0.1); color: var(--success); font-weight: bold; }
        .style-yellow { background: rgba(220, 220, 170, 0.15); color: var(--highlight); font-weight: bold; }
        .style-orange { background: rgba(206, 145, 120, 0.15); color: var(--warn); font-weight: bold; }

        /* Resource Styles */
        .res-m { color: var(--res-metal); font-weight: bold; }
        .res-e { color: var(--res-energy); font-weight: bold; }
        .drain-cell { font-family: 'Consolas', monospace; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h3>Configuration</h3>
        <div class="control-group">
            <label>Select Unit</label>
            <select id="unitSelect"><option value="">Loading...</option></select>
        </div>
        <div class="control-group">
            <label>Factory Type</label>
            <select id="factoryType">
                <option value="EXIT">Vehicle / Arm Bot (Exit Spawn)</option>
                <option value="CENTER">Cortex Bot Lab (Center Spawn)</option>
            </select>
        </div>
        <hr style="border-color: var(--border)">
        <div class="control-group">
            <label>Lab Cost (Metal / Energy / BP)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="labM" value="500"><input type="number" id="labE" value="950"><input type="number" id="labBP" value="150">
            </div>
        </div>
        <div class="control-group">
            <label>Turret Cost (Metal / Energy / BP)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="turM" value="210"><input type="number" id="turE" value="3200"><input type="number" id="turBP" value="200">
            </div>
        </div>
        <div class="control-group">
            <label>Energy-to-Metal Ratio</label>
            <input type="number" id="emRatio" value="60">
        </div>
    </div>

    <div class="main-content">
        <h2 id="unitName">Select a Unit</h2>
        
        <div class="stat-grid">
            <div class="stat-box"><small>Metal Cost</small><span id="dispMetal" class="res-m">-</span></div>
            <div class="stat-box"><small>Energy Cost</small><span id="dispEnergy" class="res-e">-</span></div>
            <div class="stat-box"><small>Build Power</small><span id="dispCost">-</span></div>
            <div class="stat-box"><small>Speed</small><span id="dispSpeed">-</span></div>
            <div class="stat-box"><small>Accel</small><span id="dispAccel">-</span></div>
            <div class="stat-box"><small>Roll-Off</small><span id="rollOffTime">-</span></div>
        </div>

        <div class="recommendation-box" id="recBox">
            <div class="rec-title">Optimal Expansion Strategy</div>
            <div class="rec-main" id="recMainText"></div>
            <div class="rec-sub" id="recSubText"></div>
        </div>

        <h3>Efficiency Comparison (Lower Score is Better)</h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">Tur</th>
                    <th>1-Lab Score</th>
                    <th>2-Lab Score</th>
                    <th>1-Lab UPM</th>
                    <th>2-Lab UPM</th>
                    <th>1-Lab Drain/s</th>
                    <th>2-Lab Drain/s</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
</div>

<script>
    let unitsDB = {};
    const MAX_TURRETS = 18;

    async function loadData() {
        try {
            const response = await fetch('bar_units_clean.json');
            if (!response.ok) throw new Error("File not found");
            unitsDB = await response.json();
            populateDropdown();
        } catch (e) {
            console.warn("JSON load failed. Using limited fallback data.");
            unitsDB = {
                "armflash": { name: "Blitz", description: "Fast Tank", cost: 1960, speed: 101, accel: 61.1, size_z: 32, metal: 110, energy: 900 },
                "corak": { name: "Grunt", description: "Standard Bot", cost: 1250, speed: 81, accel: 360, size_z: 24, metal: 42, energy: 820 }
            };
            populateDropdown();
        }
    }

    function populateDropdown() {
        const select = document.getElementById('unitSelect');
        select.innerHTML = '<option value="">-- Choose Unit --</option>';
        Object.keys(unitsDB).sort((a,b) => unitsDB[a].name.localeCompare(unitsDB[b].name))
            .forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = unitsDB[key].name;
                select.appendChild(opt);
            });
    }

    function calculatePhysics(unit, factoryMode) {
        let dist, buffer, clearanceMult;
        if (factoryMode === "EXIT") { clearanceMult = 0.65; buffer = 2.0; dist = (unit.size_z * clearanceMult) + buffer; } 
        else { clearanceMult = 1.0; buffer = 5.0; dist = (unit.size_z * clearanceMult) + buffer; }

        const t_accel = unit.speed / unit.accel;
        const d_accel = 0.5 * unit.accel * (t_accel * t_accel);

        if (dist <= d_accel) return Math.sqrt((2 * dist) / unit.accel);
        return t_accel + ((dist - d_accel) / unit.speed);
    }

    function formatDrain(metal, energy) {
        return `<span class="res-m">-${Math.round(metal)}</span> <span style="margin-left:5px;" class="res-e">-${Math.round(energy)}</span>`;
    }

    function runOptimization() {
        const unitKey = document.getElementById('unitSelect').value;
        if (!unitKey) return;

        const unit = unitsDB[unitKey];
        const factoryMode = document.getElementById('factoryType').value;
        
        // Inputs
        const labBP = parseFloat(document.getElementById('labBP').value);
        const turBP = parseFloat(document.getElementById('turBP').value);
        const labM = parseFloat(document.getElementById('labM').value);
        const labE = parseFloat(document.getElementById('labE').value);
        const turM = parseFloat(document.getElementById('turM').value);
        const turE = parseFloat(document.getElementById('turE').value);
        const emRatio = parseFloat(document.getElementById('emRatio').value);

        const wCostLab = labM + (labE / emRatio);
        const wCostTur = turM + (turE / emRatio);

        // Header Update
        document.getElementById('unitName').textContent = unit.name;
        document.getElementById('dispMetal').textContent = unit.metal;
        document.getElementById('dispEnergy').textContent = unit.energy;
        document.getElementById('dispCost').textContent = unit.cost;
        document.getElementById('dispSpeed').textContent = unit.speed;
        document.getElementById('dispAccel').textContent = unit.accel;
        const t_roll = calculatePhysics(unit, factoryMode);
        document.getElementById('rollOffTime').textContent = t_roll.toFixed(3) + "s";

        // PASS 1: DATA
        let rowData = [];
        let minScore1 = Infinity; let minIndex1 = 0;
        let minScore2 = Infinity; let minIndex2 = 0;

        for (let x = 0; x <= MAX_TURRETS; x++) {
            // Scenario A (1 Lab)
            const bp_1 = labBP + (x * turBP);
            const build_1 = unit.cost / bp_1;
            const cycle_1 = build_1 + t_roll; // Sequential (Build + Roll)
            const upm_1 = 60 / cycle_1;
            const score_1 = (wCostLab + (x * wCostTur)) / upm_1;

            // Scenario B (2 Labs)
            let upm_2 = 0;
            const cost_2 = (2 * wCostLab) + (x * wCostTur);
            
            if (x === 0) {
                upm_2 = upm_1 * 2; 
            } else {
                const bp_active = labBP + (x * turBP);
                const build_pingpong = unit.cost / bp_active;
                // Ping-Pong: Cycle for 2 units = Build + Max(Build, Roll)
                const cycle_2_units = build_pingpong + Math.max(build_pingpong, t_roll);
                upm_2 = 120 / cycle_2_units;
            }
            const score_2 = cost_2 / upm_2;

            if (score_1 <= minScore1) { minScore1 = score_1; minIndex1 = x; }
            if (score_2 <= minScore2) { minScore2 = score_2; minIndex2 = x; }

            // Resource Drain Calc
            const ups_1 = upm_1 / 60;
            const ups_2 = upm_2 / 60;
            const drain_1 = { m: ups_1 * unit.metal, e: ups_1 * unit.energy };
            const drain_2 = { m: ups_2 * unit.metal, e: ups_2 * unit.energy };

            rowData.push({ x, score_1, score_2, upm_1, upm_2, drain_1, drain_2 });
        }

        // PASS 2: BREAKPOINT
        let breakpointIndex = -1;
        rowData.forEach(row => {
            if (row.score_2 < (row.score_1 - 0.1) && breakpointIndex === -1) {
                breakpointIndex = row.x;
            }
        });

        // PASS 3: RENDER
        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = '';

        rowData.forEach(row => {
            const tr = document.createElement('tr');
            let class1 = "";
            let class2 = "";

            // Base Logic (Green Path)
            if (breakpointIndex === -1) {
                class1 = "style-green";
            } else {
                if (row.x < breakpointIndex) class1 = "style-green";
                else if (row.x === breakpointIndex) { class1 = "style-yellow"; class2 = "style-green"; }
                else class2 = "style-green";
            }

            // Saturation Logic (Override with Orange)
            const isTransitionCell = (row.x === breakpointIndex);

            if (row.x > minIndex1 && !isTransitionCell) class1 = "style-orange";
            if (row.x > minIndex2) class2 = "style-orange";

            // Format Drains
            const htmlDrain1 = formatDrain(row.drain_1.m, row.drain_1.e);
            const htmlDrain2 = formatDrain(row.drain_2.m, row.drain_2.e);

            tr.innerHTML = `
                <td>${row.x}</td>
                <td class="${class1}">${row.score_1.toFixed(1)}</td>
                <td class="${class2}">${row.score_2.toFixed(1)}</td>
                <td>${row.upm_1.toFixed(1)}</td>
                <td>${row.upm_2.toFixed(1)}</td>
                <td class="drain-cell">${htmlDrain1}</td>
                <td class="drain-cell">${htmlDrain2}</td>
            `;
            tbody.appendChild(tr);
        });

        // Rec Box Logic
        const recBox = document.getElementById('recBox');
        recBox.style.display = 'block';
        if (breakpointIndex > 0) {
             document.getElementById('recMainText').textContent = `Build 1 Lab + ${breakpointIndex} Turrets -> Then Expand.`;
             document.getElementById('recSubText').textContent = `At ${breakpointIndex} turrets (Yellow), build the turret first, then immediately buy the 2nd Factory (Green).`;
        } else if (breakpointIndex === 0) {
             document.getElementById('recMainText').textContent = "Start with 2 Factories immediately.";
             document.getElementById('recSubText').textContent = "1 Lab is inefficient from the start.";
        } else {
            document.getElementById('recMainText').textContent = "Stick to 1 Lab.";
            document.getElementById('recSubText').textContent = "2nd Lab is never efficient in this range.";
        }
    }

    // Events
    document.getElementById('unitSelect').addEventListener('change', runOptimization);
    document.getElementById('factoryType').addEventListener('change', runOptimization);
    document.querySelectorAll('input').forEach(i => i.addEventListener('input', runOptimization));

    loadData();
</script>
</body>
</html>
